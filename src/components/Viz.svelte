<script>
	import { onMount } from 'svelte';
	import { each } from 'svelte/internal';
	import { writable } from 'svelte/store';
	export let article;

	let time = 120;
	let words = article.content.replace(/<[^>]+>/g, '').split(' ');

	let newWords = [];
	$: addedWords = new Set();

	async function fetchData() {
		const res = await fetch(`/api/get`);
		newWords = await res.json();
		return newWords;
	}

	onMount(async () => {
		await fetchData();

		//  i have to use eventlisteners because svelte is an asshole
		// or i'm just not capable
		let animateElements = document.querySelectorAll('animate');
		animateElements.forEach((element) => {
			element.addEventListener('endEvent', () => {
				let word = element.parentElement?.textContent;
				if (wordInNewWords(word)) {
					addedWords.add(word);
				}
			});
		});
	});

	function wordInNewWords(word) {
		return newWords.includes(word);
	}
</script>

<div class="chart">
	{#if newWords.length == 0}
		<p>Loading...</p>
	{:else}
		<svg viewBox="0 0 800 536" preserveAspectRatio="none">
			<path
				id="default"
				d="m15.91,0v89.68c0,5.15,4.17,9.32,9.32,9.32h468.23c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v.78c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v2.34c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.74c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v2.14c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v.77c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.58c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.54c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.59c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.96c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.53c0,4.68,3.83,8.51,8.51,8.51h477.85c4.54,0,8.22,3.68,8.22,8.22v.9c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.22c-4.57,0-8.27,3.73-8.22,8.31l.02,1.68c.05,4.51,3.71,8.13,8.22,8.13h478.23c4.54,0,8.22,3.68,8.22,8.22v.75c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v2.6c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.37c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.41c0,4.54,3.68,8.22,8.22,8.22h749.11c4.55,0,8.23-3.69,8.22-8.24l-.72-495.76c-.01-4.53-3.68-8.19-8.21-8.2l-235.58-.24c-4.54,0-8.23,3.68-8.23,8.22v83.64c0,3.63,2.95,6.58,6.58,6.58h272.42"
				stroke="#d5cfff"
				stroke-width="16"
				fill="none"
			/>
			<path
				id="new"
				d="m15.91,0v89.68c0,5.15,4.17,9.32,9.32,9.32h468.23c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v.78c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v2.34c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.74c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v2.14c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v.77c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.58c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.54c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.59c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.96c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.53c0,4.68,3.83,8.51,8.51,8.51h477.85c4.54,0,8.22,3.68,8.22,8.22v.9c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.56c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.56c0,4.54-3.68,8.22-8.22,8.22H15.22c-4.57,0-8.27,3.73-8.22,8.31l.02,1.68c.05,4.51,3.71,8.13,8.22,8.13h478.23c4.54,0,8.22,3.68,8.22,8.22v.75c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v2.6c0,4.54,3.68,8.22,8.22,8.22h478.14c4.54,0,8.22,3.68,8.22,8.22v1.37c0,4.54-3.68,8.22-8.22,8.22H15.32c-4.54,0-8.22,3.68-8.22,8.22v1.41c0,4.54,3.68,8.22,8.22,8.22h749.11c4.55,0,8.23-3.69,8.22-8.24l-.72-495.76c-.01-4.53-3.68-8.19-8.21-8.2l-235.58-.24c-4.54,0-8.23,3.68-8.23,8.22v83.64c0,3.63,2.95,6.58,6.58,6.58h56.42c14.91,0,27-12.09,27-27h0c0-14.91-12.09-27-27-27h0c-14.91,0-27,12.09-27,27v423h27"
				stroke="#d5cfff"
				stroke-width="16"
				fill="none"
			/>
			{#each words as word, i}
				{#if wordInNewWords(word)}
					<text font-size="12" dy="4">
						<textPath xlink:href="#new" startOffset="-10%">
							{word}
							<animate
								attributeName="startOffset"
								from="0%"
								to="110%"
								begin="{i * 1}s"
								end="{i + time}s"
								dur="{time}s"
							/>
						</textPath>
					</text>
				{:else}
					<text font-size="12" dy="4">
						<textPath xlink:href="#default" startOffset="-10%">
							{word}
							<animate
								attributeName="startOffset"
								from="0%"
								to="110%"
								begin="{i * 1}s"
								end="{i * 1 + time}s"
								dur="{time}s"
							/>
						</textPath>
					</text>
				{/if}
			{/each}
		</svg>
		<div class="newWords">
			{#each Array.from(addedWords) as w}
				<span>{w}</span>
			{/each}
		</div>
	{/if}
</div>
<input type="range" bind:value={time} min="10" max="200" />

<style>
	.newWords {
		font-family: Arial, Helvetica, sans-serif;
		position: absolute;
		width: 21%;
		left: 73%;
		top: 26%;
		height: 71%;
		word-break: break-all;
		display: flex;
		align-items: flex-end;
	}

	.chart {
		position: relative;
		width: 100%;
		max-width: 1280px;
		margin: 0 auto;
		box-shadow: 0 30px 40px rgba(0, 0, 0, 0.1);
	}

	text {
		font-family: Arial, Helvetica, sans-serif;
	}
</style>
